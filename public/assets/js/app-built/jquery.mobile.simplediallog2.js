/*
 * jQuery Mobile Framework : plugin to provide a dialogs Widget. ver2
 * Copyright (c) JTSage
 * CC 3.0 Attribution.  May be relicensed without permission/notifcation.
 * https://github.com/jtsage/jquery-mobile-simpledialog
 */

(function(e,t){e.widget("mobile.simpledialog2",e.mobile.widget,{options:{version:"1.0.1-2012061300",mode:"blank",themeDialog:"b",themeInput:!1,themeButtonDefault:!1,themeHeader:"a",fullScreen:!1,fullScreenForce:!1,dialogAllow:!1,dialogForce:!1,headerText:!1,headerClose:!1,buttonPrompt:!1,buttonInput:!1,buttonInputDefault:!1,buttonPassword:!1,blankContent:!1,blankContentAdopt:!1,resizeListener:!0,safeNuke:!0,forceInput:!0,showModal:!0,animate:!0,transition:"pop",clickEvent:"click",zindex:"500",width:"280px",left:!1,top:!1,callbackOpen:!1,callbackOpenArgs:[],callbackClose:!1,callbackCloseArgs:[]},_eventHandler:function(e,t){var n=e.data.widget,r=e.data.widget.options;if(!e.isPropagationStopped())switch(t.method){case"close":n.close();break;case"html":n.updateBlank(t.source)}},_create:function(){var t=this,n=e.extend(this.options,this.element.jqmData("options")),r=new Date,i=e("<div class='ui-simpledialog-container ui-overlay-shadow ui-corner-all ui-simpledialog-hidden "+(n.animate===!0?n.transition:"")+" ui-body-"+n.themeDialog+"'></div>");n.themeButtonDefault===!1&&(n.themeButtonDefault=n.themeDialog),n.themeInput===!1&&(n.themeInput=n.themeDialog),e.mobile.sdCurrentDialog=t,typeof e.mobile.sdLastInput!="undefined"&&delete e.mobile.sdLastInput,t.internalID=r.getTime(),t.displayAnchor=e.mobile.activePage.children(".ui-content").first(),t.displayAnchor.length===0&&(t.displayAnchor=e.mobile.activePage),t.dialogPage=e("<div data-role='dialog' data-theme='"+n.themeDialog+"'><div data-role='header'></div><div data-role='content'></div></div>"),t.sdAllContent=t.dialogPage.find("[data-role=content]"),i.appendTo(t.sdAllContent),t.sdIntContent=t.sdAllContent.find(".ui-simpledialog-container"),t.sdIntContent.css("width",n.width);if(n.headerText!==!1||n.headerClose!==!1)t.sdHeader=e('<div style="margin-bottom: 4px;" class="ui-header ui-bar-'+n.themeHeader+'"></div>'),n.headerClose===!0&&e("<a class='ui-btn-left' rel='close' href='#'>Close</a>").appendTo(t.sdHeader).buttonMarkup({theme:n.themeHeader,icon:"delete",iconpos:"notext",corners:!0,shadow:!0}),e('<h1 class="ui-title">'+(n.headerText!==!1?n.headerText:"")+"</h1>").appendTo(t.sdHeader),t.sdHeader.appendTo(t.sdIntContent);n.mode==="blank"?(n.blankContent===!0&&(n.blankContentAdopt===!0?n.blankContent=t.element.children():n.blankContent=t.element.html()),e(n.blankContent).appendTo(t.sdIntContent)):n.mode==="button"&&t._makeButtons().appendTo(t.sdIntContent),t.sdIntContent.appendTo(t.displayAnchor.parent()),t.dialogPage.appendTo(e.mobile.pageContainer).page().css("minHeight","0px").css("zIndex",n.zindex),n.animate===!0&&t.dialogPage.addClass(n.transition),t.screen=e("<div>",{"class":"ui-simpledialog-screen ui-simpledialog-hidden"}).css("z-index",n.zindex-1).appendTo(t.displayAnchor.parent()).bind(n.clickEvent,function(e){n.forceInput||t.close(),e.preventDefault()}),n.showModal&&t.screen.addClass("ui-simpledialog-screen-modal"),e(document).bind("simpledialog."+t.internalID,{widget:t},function(e,n){t._eventHandler(e,n)})},_makeButtons:function(){var t=this,n=t.options,r=e("<div></div>"),i=e("<div class='ui-simpledialog-controls'><input class='ui-simpledialog-input ui-input-text ui-shadow-inset ui-corner-all ui-body-"+n.themeInput+"' type='"+(n.buttonPassword===!0?"password":"text")+"' value='"+(n.buttonInputDefault!==!1?n.buttonInputDefault.replace('"',"&#34;").replace("'","&#39;"):"")+"' name='pickin' /></div>"),s=e("<div>",{"class":"ui-simpledialog-controls"});return n.buttonPrompt!==!1&&(t.buttonPromptText=e("<p class='ui-simpledialog-subtitle'>"+n.buttonPrompt+"</p>").appendTo(r)),n.buttonInput!==!1&&(e.mobile.sdLastInput="",i.appendTo(r),i.find("input").bind("change",function(){e.mobile.sdLastInput=i.find("input").first().val(),t.thisInput=i.find("input").first().val()})),s.appendTo(r),t.butObj=[],e.each(n.buttons,function(r,i){i=e.isFunction(i)?{click:i}:i,i=e.extend({text:r,id:r+t.internalID,theme:n.themeButtonDefault,icon:"check",iconpos:"left",corners:"true",shadow:"true",args:[],close:!0},i),t.butObj.push(e("<a href='#'>"+r+"</a>").appendTo(s).attr("id",i.id).buttonMarkup({theme:i.theme,icon:i.icon,iconpos:i.iconpos,corners:i.corners,shadow:i.shadow}).unbind("vclick click").bind(n.clickEvent,function(){n.buttonInput&&t.sdIntContent.find("input [name=pickin]").trigger("change");var r=i.click.apply(t,e.merge(arguments,i.args));r!==!1&&i.close===!0&&t.close()}))}),r},_getCoords:function(t){var n=t,r=e.mobile.activePage.width(),i=e(window).scrollTop(),s=e(window).height(),o=t.sdIntContent.innerWidth(),u=t.sdIntContent.outerHeight(),a={high:e(window).height(),width:e.mobile.activePage.width(),fullTop:e(window).scrollTop(),fullLeft:e(window).scrollLeft(),winTop:i+(t.options.top!==!1?t.options.top:s/2-u/2),winLeft:t.options.left!==!1?t.options.left:r/2-o/2};return a.winTop<45&&(a.winTop=45),a},_orientChange:function(e){var t=e.data.widget,n=e.data.widget.options,r=e.data.widget._getCoords(e.data.widget);e.stopPropagation();if(t.isDialog===!0)return!0;n.fullScreen===!0&&(r.width<400||n.fullScreenForce===!0)?t.sdIntContent.css({border:"none",position:"absolute",top:r.fullTop,left:r.fullLeft,height:r.high,width:r.width,maxWidth:r.width}).removeClass("ui-simpledialog-hidden"):t.sdIntContent.css({position:"absolute",top:r.winTop,left:r.winLeft}).removeClass("ui-simpledialog-hidden")},repos:function(){var e={data:{widget:this},stopPropagation:function(){return!0}};this._orientChange(e)},open:function(){var t=this,n=this.options,r=this._getCoords(this);t.sdAllContent.find(".ui-btn-active").removeClass("ui-btn-active"),t.sdIntContent.delegate("[rel=close]",n.clickEvent,function(e){e.preventDefault(),t.close()}),n.dialogAllow===!0&&r.width<400||n.dialogForce?(t.isDialog=!0,n.mode==="blank"&&t.sdIntContent.find("select").each(function(){e(this).jqmData("nativeMenu",!0)}),t.displayAnchor.parent().unbind("pagehide.remove"),t.sdAllContent.append(t.sdIntContent),t.sdAllContent.trigger("create"),n.headerText!==!1&&(t.sdHeader.find("h1").appendTo(t.dialogPage.find("[data-role=header]")),t.sdIntContent.find(".ui-header").empty().removeClass()),n.headerClose===!0?t.dialogPage.find(".ui-header a").bind("click",function(){setTimeout("$.mobile.sdCurrentDialog.destroy();",1e3)}):t.dialogPage.find(".ui-header a").remove(),t.sdIntContent.removeClass().css({top:"auto",width:"auto",left:"auto",marginLeft:"auto",marginRight:"auto",zIndex:n.zindex}),e.mobile.changePage(t.dialogPage,{transition:n.animate===!0?n.transition:"none"})):(t.isDialog=!1,t.selects=[],n.fullScreen===!1&&(n.showModal===!0&&n.animate===!0?t.screen.fadeIn("slow"):t.screen.removeClass("ui-simpledialog-hidden")),t.sdIntContent.addClass("ui-overlay-shadow in").css("zIndex",n.zindex).trigger("create"),n.fullScreen===!0&&(r.width<400||n.fullScreenForce===!0)?t.sdIntContent.removeClass("ui-simpledialog-container").css({border:"none",position:"absolute",top:r.fullTop,left:r.fullLeft,height:r.high,width:r.width,maxWidth:r.width}).removeClass("ui-simpledialog-hidden"):t.sdIntContent.css({position:"absolute",top:r.winTop,left:r.winLeft}).removeClass("ui-simpledialog-hidden"),e(document).bind("orientationchange.simpledialog",{widget:t},function(e){t._orientChange(e)}),n.resizeListener===!0&&e(window).bind("resize.simpledialog",{widget:t},function(e){t._orientChange(e)})),e.isFunction(n.callbackOpen)&&n.callbackOpen.apply(t,n.callbackOpenArgs)},close:function(){var t=this,n=this.options,r;if(e.isFunction(t.options.callbackClose)){r=t.options.callbackClose.apply(t,t.options.callbackCloseArgs);if(r===!1)return!1}t.isDialog?(e(t.dialogPage).dialog("close"),t.sdIntContent.addClass("ui-simpledialog-hidden"),t.sdIntContent.appendTo(t.displayAnchor.parent()),e.mobile.activePage.jqmData("page").options.domCache!=1&&e.mobile.activePage.is(":jqmData(external-page='true')")&&e.mobile.activePage.bind("pagehide.remove",function(){e(this).remove()})):(t.options.showModal===!0&&t.options.animate===!0?t.screen.fadeOut("slow"):t.screen.addClass("ui-simpledialog-hidden"),t.sdIntContent.addClass("ui-simpledialog-hidden").removeClass("in"),e(document).unbind("orientationchange.simpledialog"),t.options.resizeListener===!0&&e(window).unbind("resize.simpledialog")),n.mode==="blank"&&n.blankContent!==!1&&n.blankContentAdopt===!0&&(t.element.append(n.blankContent),n.blankContent=!0),t.isDialog===!0||t.options.animate===!0?setTimeout(function(e){return function(){e.destroy()}}(t),1e3):t.destroy()},destroy:function(){var t=this,n=t.element;t.options.mode==="blank"&&e.mobile.sdCurrentDialog.sdIntContent.find("select").each(function(){e(this).data("nativeMenu")==0&&(e(this).data("selectmenu").menuPage.remove(),e(this).data("selectmenu").screen.remove(),e(this).data("selectmenu").listbox.remove())}),e(t.sdIntContent).remove(),e(t.dialogPage).remove(),e(t.screen).remove(),e(document).unbind("simpledialog."+t.internalID),delete e.mobile.sdCurrentDialog,e.Widget.prototype.destroy.call(t),t.options.safeNuke===!0&&e(n).parents().length===0&&e(n).contents().length===0&&n.remove()},updateBlank:function(t){var n=this,r=this.options;n.sdIntContent.empty();if(r.headerText!==!1||r.headerClose!==!1)n.sdHeader=e('<div class="ui-header ui-bar-'+r.themeHeader+'"></div>'),r.headerClose===!0&&e("<a class='ui-btn-left' rel='close' href='#'>Close</a>").appendTo(n.sdHeader).buttonMarkup({theme:r.themeHeader,icon:"delete",iconpos:"notext",corners:!0,shadow:!0}),e('<h1 class="ui-title">'+(r.headerText!==!1?r.headerText:"")+"</h1>").appendTo(n.sdHeader),n.sdHeader.appendTo(n.sdIntContent);e(t).appendTo(n.sdIntContent),n.sdIntContent.trigger("create"),e(document).trigger("orientationchange.simpledialog")},_init:function(){this.open()}})})(jQuery);