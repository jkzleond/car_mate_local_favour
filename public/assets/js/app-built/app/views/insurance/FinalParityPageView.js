define(["jquery","underscore","backbone","models/insurance/PolicyFormModel","collections/insurance/FinalResultCollection","text!templates/insurance/final_parity_price_page.html","text!templates/insurance/result_detail.html","jqplot_bar","base64"],function(e,t,n,r,i,s,o){e(s).appendTo("body");var u=n.View.extend({el:"#insurance_final_parity_price_page",initialize:function(n){this.form_model=new r,this.actuary_results=new i,this.plot_actual_amount_data=[0],this.plot_discount_data=[0],this.plot_gift_money_data=[0],this.plot_ticks=[],this.plot=e.jqplot("insurance_final_parity_price_chart_container",[this.plot_actual_amount_data,this.plot_gift_money_data],{title:"精算比价",animate:!1,stackSeries:!0,captureRightClick:!0,seriesDefaults:{renderer:e.jqplot.BarRenderer,rendererOptions:{barMargin:10,highlightMouseDown:!0},pointLabels:{show:!0}},axes:{xaxis:{renderer:e.jqplot.CategoryAxisRenderer,ticks:this.plot_ticks,label:"点击柱状图,显示精算详情"},yaxis:{rendererOptions:{forceTickAt0:!0},padMin:0}},legend:{labels:["实际只需","礼包"],show:!0,location:"se",placement:"inside"}}),this.result_detail_tpl=t.template(o),this.listenTo(this.actuary_results,"reset",this._render),this.listenTo(this.form_model,"invalid",this._onFormInvalid),this.listenTo(this.form_model,"sync",this._onApplyPolicySuccess)},events:{"jqplotDataClick #insurance_final_parity_price_chart_container":"_onChartSeriesClick","click .apply-policy-btn":"_onApplyPolicyBtnClick"},_onChartSeriesClick:function(e,t,n,r){var i=this.actuary_results.models[n].attributes;this.form_model.set("company_id",i.company_id),this.form_model.set("result_id",i.result_id),this.$el.find(".result-detail").empty().append(this.result_detail_tpl({result:i}))},_onApplyPolicyBtnClick:function(e){this.form_model.isValid()&&this.form_model.save()},_onFormInvalid:function(t,n){e.cm.toast({msg:n})},_onApplyPolicySuccess:function(e,t,n){t.success&&this.trigger("uri",this,"insurance/"+this.form_model.get("info_id")+"/pay_order")},_render:function(e,t){var n=e.models,r=n.length;this.plot_actual_amount_data.splice(0,this.plot_actual_amount_data.length),this.plot_gift_money_data.splice(0,this.plot_gift_money_data.length),this.plot_ticks.splice(0,this.plot_ticks.length);for(var i=0;i<r;i++){var s=n[i].attributes;this.plot_actual_amount_data.push(Number(Number(s.totalAfterDiscount-s.giftMoney).toFixed(2))),this.plot_discount_data.push(Number(Number(s.totalStandard-s.totalAfterDiscount).toFixed(2))),this.plot_gift_money_data.push(Number(s.giftMoney)),this.plot_ticks.push(s.company_short_name)}this.plot.replot({data:[this.plot_actual_amount_data,this.plot_gift_money_data],resetAxes:!0,axes:{xaxis:{ticks:this.plot_ticks}}})},loadInfo:function(e){this._clear(),this.form_model.set("info_id",e,{silent:!0}),this.actuary_results.setInfoId(e),this.actuary_results.fetch({reset:!0})},_clear:function(){this.form_model.clear(),this.$el.find(".result-detail").empty()}});return u});