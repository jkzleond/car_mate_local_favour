define(["jquery","underscore","backbone","models/insurance/InsuranceInfoModel","collections/insurance/InsuranceCompanyCollection","text!templates/insurance/parity_price_page.html","text!templates/insurance/discount_detail.html","jqplot_bar"],function(e,t,n,r,i,s,o){e(s).appendTo("body");var u=n.View.extend({el:"#insurance_parity_price_page",initialize:function(n){this.plot_actual_amount_data=[0],this.plot_gift_data=[0],this.plot_ticks=[],this.plot=e.jqplot("insurance_parity_price_chart_container",[this.plot_actual_amount_data,this.plot_gift_data],{title:"比价",animate:!1,stackSeries:!0,captureRightClick:!0,seriesDefaults:{renderer:e.jqplot.BarRenderer,rendererOptions:{barMargin:10,highlightMouseDown:!0},pointLabels:{show:!0}},axes:{xaxis:{renderer:e.jqplot.CategoryAxisRenderer,ticks:this.plot_ticks,label:"点击柱状图,显示初算详情"},yaxis:{rendererOptions:{forceTickAt0:!0},padMin:0}},legend:{labels:["实际只需","礼包"],show:!0,location:"se",placement:"inside"}}),this.total_standard=0,this.discount_detail_tpl=t.template(o),this.insurance_info=new r,this.company=new i,this.listenTo(this.insurance_info,"change:result",this._resultProcess),this.listenTo(this.company,"reset",this._discountProcess)},events:{"jqplotDataClick #insurance_parity_price_chart_container":"_onChartSeriesClick","click .apply-actual-btn":"_onApplyActualBtnClick"},_onChartSeriesClick:function(e,t,n,r){var i=this.insurance_info.attributes,s=this.company.models[n].attributes,o=this.insurance_info.result.attributes;this.$el.find(".discount-detail").empty().append(this.discount_detail_tpl({info:i,company:s,result:o})),this.$el.find(".apply-actual-btn").show()},_onApplyActualBtnClick:function(e){this.trigger("uri",this,"insurance/apply_actual/"+this.insurance_info.get("id"))},_resultProcess:function(e,t,n){var r=t.attributes;this.standard_compulsory=Number(r.standardCompulsoryInsurance)||0,this.after_discount_compulsory=Number(r.afterDiscountCompulsoryInsurance||0),this.standard_damage=Number(r.standardDamageInsurance)||0,this.coefficient=r.coefficient,this.standard_third=Number(r.standardThird)||0,this.standard_driver=Number(r.standardDriver)||0,this.standard_passenger=Number(r.standardPassenger)||0,this.standard_robbery=Number(r.standardRobbery)||0,this.standard_glass=Number(r.standardGlass)||0,this.standard_scratch=Number(r.standardScratch)||0,this.standard_self_ignition=Number(r.standardSelfIgnition)||0,this.standard_optional_deductible=Number(r.standardOptionalDeductible)||0,this.standard_not_deductible=Number(r.standardNotDeductible)||0,this.total_standard=Number(r.totalStandard)||0;if(this.company.models.length==0)return;var i=this.company.models.length;this.plot_actual_amount_data.splice(0,this.plot_actual_amount_data.length),this.plot_gift_data.splice(0,this.plot_gift_data.length),this.plot_ticks.splice(0,this.plot_ticks.length);for(var s=0;s<i;s++){var o=this.company.models[s].attributes;if(o.gift==0&&this.standard_damage)continue;this.plot_ticks.push(o.short_name);var u=Number(o.discount),a=Number(o.car_price_discount),f=this.after_discount_compulsory,l=0,c=0;this.coefficient==1?(c=(this.standard_damage-619)*100/1.47*a,l=Math.round((c*1.47/100+619)*100)/100):this.coefficient==2?(c=(this.standard_damage-590)*100/1.4*a,l=Math.round((c*1.4/100+590)*100)/100):this.coefficient==3||this.coefficient==4||this.coefficient==5?(c=(this.standard_damage-584)*100/1.39*a,l=Math.round((c*1.39/100+584)*100)/100):this.coefficient==6&&(c=(this.standard_damage-602)*100/1.43*a,l=Math.round((c*1.43/100+602)*100)/100);var h=this.standard_third*u,p=this.standard_driver*u,d=this.standard_passenger*u,v=this.standard_robbery*u,m=this.standard_glass*u,g=this.standard_scratch*u,y=this.standard_self_ignition*u,b=this.standard_optional_deductible*u,w=this.standard_not_deductible*u,E=(this.total_standard-this.standard_compulsory)*u+f,S=Number(o.gift),x=Number(o.gift2),T=Number(o.gift3),N=0,C=this.insurance_info.get("car_type_id");C==1?l!=0?(E=(this.total_standard-this.standard_damage-this.standard_compulsory)*u+l+f,N=E*S):N=E*x:N=0,this.plot_actual_amount_data.push(Math.floor((E-N)*100)/100),this.plot_gift_data.push(Math.ceil(N*100)/100)}this.plot.replot({data:[this.plot_actual_amount_data,this.plot_gift_data],resetAxes:!0,axes:{xaxis:{ticks:this.plot_ticks,numberTicks:this.plot_ticks.length}}})},_discountProcess:function(e,t){if(this.total_standard==0)return;console.log("company");var n=this.company.models.length;this.plot_actual_amount_data.splice(0,this.plot_actual_amount_data.length),this.plot_gift_data.splice(0,this.plot_gift_data.length),this.plot_ticks.splice(0,this.plot_ticks.length);for(var r=0;r<n;r++){var i=this.company.models[r].attributes;if(i.gift==0&&this.standard_damage)continue;this.plot_ticks.push(i.short_name);var s=Number(i.discount),o=Number(i.car_price_discount),u=this.after_discount_compulsory,a=0,f=0;this.coefficient==1?(f=(this.standard_damage-619)*100/1.47*o,a=Math.round((f*1.47/100+619)*100)/100):this.coefficient==2?(f=(this.standard_damage-590)*100/1.4*o,a=Math.round((f*1.4/100+590)*100)/100):this.coefficient==3||this.coefficient==4||this.coefficient==5?(f=(this.standard_damage-584)*100/1.39*o,a=Math.round((f*1.39/100+584)*100)/100):this.coefficient==6&&(f=(this.standard_damage-602)*100/1.43*o,a=Math.round((f*1.43/100+602)*100)/100);var l=this.standard_third*s,c=this.standard_driver*s,h=this.standard_passenger*s,p=this.standard_robbery*s,d=this.standard_glass*s,v=this.standard_scratch*s,m=this.standard_self_ignition*s,g=this.standard_optional_deductible*s,y=this.standard_not_deductible*s,b=(this.total_standard-this.standard_compulsory)*s+u,w=Number(i.gift),E=Number(i.gift2),S=Number(i.gift3),x=0,T=this.insurance_info.get("car_type_id");T==1?a!=0?(b=(this.total_standard-this.standard_damage-this.standard_compulsory)*s+a+u,x=b*w):x=b*E:x=0,this.plot_actual_amount_data.push(Math.floor((b-x)*100)/100),this.plot_gift_data.push(Math.ceil(x*100)/100)}this.plot.replot({data:[this.plot_actual_amount_data,this.plot_gift_data],resetAxes:!0,axes:{xaxis:{ticks:this.plot_ticks,numberTicks:this.plot_ticks.length}}})},loadInfo:function(e){this.$el.find(".apply-actual-btn").hide(),this.$el.find(".discount-detail").empty(),this.insurance_info.set("id",e,{silent:!0}),this.insurance_info.fetch(),this.company.fetch({reset:!0})}});return u});