define(["jquery","underscore","backbone","models/CarInfoModel","models/insurance/InsuranceReservationFormModel","text!templates/insurance/reservation_page.html","jqm","datetimepicker"],function(e,t,n,r,i,s){e(s).appendTo("body");var o=n.View.extend({el:"#insurance_reservation_page",initialize:function(){this.model=new i,this.car_info_model=new r,this.$el.find('[name="offer_date"]').datetimepicker({lang:"ch",format:"Y-m-d",formatDate:"Y/m/d",timepicker:!1,minDate:"-1970/01/01"}),this.listenTo(this.model,"invalid",this._onFormModelInvalid),this.listenTo(this.model,"sync",this._onFormModelSync),this.listenTo(this.car_info_model,"request",this._lockSubmit),this.listenTo(this.car_info_model,"sync",this._renderCarInfo),this.listenTo(this.car_info_model,"sync",this._unlockSubmit)},events:{"input [name=hphm]":"_onHphmInput","change [name=hphm]":"_onHphmChange","click .reservation-btn":"_onReservationBtnClick"},_onHphmInput:function(e){this.$el.find("[name=auto_name]").prop("disabled",!1).val(""),this.$el.find("[name=frame_number]").prop("disabled",!1).val(""),this.$el.find("[name=engine_number]").prop("disabled",!1).val("")},_onHphmChange:function(t){var n=this.$el.find('[name="hphm_header"]').val()+e(t.target).val();this.car_info_model.clear({silent:!0}),this.car_info_model.set({hphm:n,user_id:G.user.user_id}),this.car_info_model.fetch({reset:!0})},_onReservationBtnClick:function(e){this._collectionFormData(),this.model.isValid()&&this.model.save()},_onFormModelSync:function(e,t,n){if(!t.success)return;this.$el.find("#insurance_reservation_result_popup").popup("open")},_onFormModelInvalid:function(t,n){e.cm.toast({msg:n})},_collectionFormData:function(){var t=this,n=this.model.get("info_id");this.model.clear({silent:!0}),this.model.set("info_id",n,{silent:!0});var t=this;this.$el.find("[name]:visible:not([data-ignore])").each(function(n,r){var i=e(r).attr("name"),s=e(r).val();i=="hphm"&&s&&(s=t.$el.find('[name="hphm_header"]').val()+s),t.model.set(i,s,{silent:!0})}),t.model.set("user_id",G.user.user_id,{silent:!0}),t.model.set("car_info_id",this.car_info_model.get("id"))},_lockSubmit:function(e,t,n){this.$el.find(".reservation-btn").prop("disabled",!0)},_unlockSubmit:function(e,t,n){this.$el.find(".reservation-btn").prop("disabled",!1)},_renderCarInfo:function(e,t,n){if(!t.row)return;this.$el.find("[name=auto_name]").val(e.get("auto_name")).prop("disabled",!0),this.$el.find("[name=frame_number]").val(e.get("frame_number")).prop("disabled",!0),this.$el.find("[name=engine_number]").val(e.get("engine_number")).prop("disabled",!0)},reset:function(){this.$el.find("[name=phone]").val(G.user.phone||"")}});return o});