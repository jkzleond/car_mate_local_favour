define(["jquery","underscore","backbone","models/insurance/InsuranceOrderInfoModel","collections/CityCollection","collections/ProvinceCollection","text!templates/insurance/pay_order_page.html","text!templates/insurance/order_info_detail.html"],function(e,t,n,r,i,s,o,u){e(o).appendTo("body");var a=n.View.extend({model:new r,el:"#insurance_pay_order_page",initialize:function(e){this.city_collection=new i,this.province_collection=new s,this.order_info_deital_tpl=t.template(u),this.listenTo(this.model,"change:id",this._render),this.listenTo(this.model,"invalid",this._onModelInvalid),this.listenTo(this.city_collection,"reset",this._renderCitySelect),this.listenTo(this.province_collection,"reset",this._renderProvinceSelect)},events:{"change .province-select":"_onProvinceSelectChange","change .city-select":"_onCitySelectChange","click .certain-policy-btn":"_onCertainPolicyBtnClick"},_onProvinceSelectChange:function(t){var n=e(t.target),r=n.val();this.city_collection.setProvinceId(r)},_onCitySelectChange:function(t){this.$el.find(".city-select").attr("data-value",e(t.target).val())},_onCertainPolicyBtnClick:function(t){this._collectionFormData();if(this.model.isValid()){var n=this;this.model.save(this.model.attributes,{success:function(t,r,i){if(!r.success)return;if(G.user_id=="WEIBO_ACCOUNT"){e.cm.toast({msg:"请使用线下付款方式"}),this.trigger("uri",n,"insurances/4");return}var s="<root><orderId>"+n.model.get("order_id")+"</orderId><orderNo>"+n.model.get("order_no")+"</orderNo><orderFee>"+n.model.get("order_fee")+"</orderFee><payType><offline>1</offline><alipay>1</alipay><wxpay>1</wxpay></payType><des>"+encodeURIComponent("保险保费")+"</des></root>";window.location.href="pay://yn.122.net/?ordername="+encodeURIComponent("保险保费")+"&orderinfo="+encodeURIComponent(base64encode(s))}})}},_onModelInvalid:function(t,n){e.cm.toast({msg:n})},_render:function(e,t,n){this.$el.find(".order-info-detail").empty().append(this.order_info_deital_tpl(this.model.toJSON())),this.province_collection.fetch({reset:!0})},_renderCitySelect:function(t,n){var r=this.$el.find(".city-select");r.empty(),e.each(t.models,function(e,t){var n=t.get("id"),i=t.get("name"),s="";n==(r.attr("data-value")||G.user.city_id)&&(s="selected"),r.append('<option value="'+n+'" '+s+">"+i+"</option>")})},_renderProvinceSelect:function(t,n){var r=this.$el.find(".province-select");r.empty(),e.each(t.models,function(e,t){var n=t.get("id"),i=t.get("name"),s="";n==(G.user.province_id||1)&&(s="selected"),r.append('<option value="'+n+'" '+s+">"+i+"</option>")}),r.change()},_collectionFormData:function(){var e=this.$el.find(".province-select").val(),t=this.$el.find(".city-select").val(),n=this.$el.find(".address").val();this.model.set("province_id",e,{silent:!0}),this.model.set("city_id",t,{silent:!0}),this.model.set("address",n,{silent:!0})},loadOrderInfo:function(e){this.model.clear({silent:!0}),this.$el.find(".order-info-detail").empty(),this.model.set("insurance_info_id",e,{silent:!0}),this.model.fetch()}});return a});