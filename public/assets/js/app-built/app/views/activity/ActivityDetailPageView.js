define(["jquery","underscore","backbone","models/activity/ActivityModel","models/activity/ActivitySignFormModel","text!templates/activity/activity_detail_page.html","text!templates/activity/activity_detail.html","pcas","jqm"],function(e,t,n,r,i,s,o,u){e(s).appendTo("body");var a=n.View.extend({detail_tpl:t.template(o),model:new r,sign_form_model:new i,el:"#activity_detail_page",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.sign_form_model,"invalid",this.onSignModelInValid),this.listenTo(this.sign_form_model,"change:order_info",this.onSignModelOrderInfoChange),new u("activity_province","activity_city","activity_area")},render:function(t,n){this.$el.find(".detail-container").empty(),this.$el.find("#activity_sign_up_btn").hide();if(t.keys().length==0)return;e("title").text(this.model.get("name")),this.$el.find(".detail-container").append(this.detail_tpl(t.toJSON()));var r=t.get("state"),i=t.get("sign_start_date"),s=t.get("sign_end_date"),o=new Date(i),u=new Date(s),a=Date.today();r!=1||i&&Date.compare(o,a)==1||s&&Date.compare(u,a)==-1?this.$el.find("#activity_sign_up_btn").hide():this.$el.find("#activity_sign_up_btn").show();var f=t.get("infos")||"";this.$el.find("#activity_sign_up_form_container [data-field]").each(function(t,n){var r=e(n).attr("data-field");f.indexOf(r)!=-1?e(n).show():e(n).hide()}),e('[data-field="auto"]').find("#activity_option_label").text(t.get("option")),e('[data-field="select"]').find("#activity_select_label").text(t.get("sel_name")),this.$el.find("[name=selected]").empty();var l=t.get("sel_items_text"),c=t.get("sel_items_value");if(l){var h=l.split(","),p=c.split(","),d=p.length;for(var v=0;v<d;v++)this.$el.find("[name=selected]").append('<option value="'+p[v]+'">'+h[v]+"</option>")}e('[name="user_id"]').val(G.user.user_id),e('[name="uname"]').val(G.user.uname||""),e('[name="phone"]').val(G.user.phone||"");var m=t.get("need_pay");if(m==1){e('#activity_sign_up_form_container [data-field="pay_items"]').show(),e('#activity_sign_up_form_container [data-field="total_fee"]').show(),e('#activity_sign_up_form_container [name="total_fee"]').text("0.00");var g=t.get("goods"),y=g.length;e("#activity_pay_items_container").empty();for(var v=0;v<y;v++){var b=e('<tr class="activity-pay-item" data-id="'+g[v].id+'" data-price="'+g[v].price+'"></tr>');e("#activity_pay_items_container").append(b),b.append("<td>"+g[v].name+"</td>"),b.append('<td class="cm-color-money">'+g[v].price+"</td>"),b.append('<td class="cm-numberspinner cm-span6 activity-pay-item-number"></td>'),b.find(".cm-numberspinner").numberspinner({change:function(t,n){var r=0;e("#activity_pay_items_container .activity-pay-item").each(function(t,n){var i=Number(e(n).attr("data-price")),s=e(n).find(".activity-pay-item-number").numberspinner("getValue");r+=i*s}),e('#activity_sign_up_form_container [name="total_fee"]').text(Number(r).toFixed(2))}}),v==0&&b.find(".cm-numberspinner .cm-plus-btn").click()}}else e('#activity_sign_up_form_container [data-field="pay_items"]').hide()},events:{"click #activity_sign_up_btn":"onSignUpBtnClick","click #activity_sign_up_submit_btn":"onSignUpSubmit",'change [name="pay_type"]':"onPayTypeChange"},onSignUpBtnClick:function(t){return t.preventDefault(),e("#activity_sign_up_popup").popup("open"),!1},onPeopleNumberInput:function(e){var t=this.$el.find('[name="people"]').val(),n=this.$el.find('[name="deposit"]').val(),r=Number(t)*Number(n);this.$el.find("total_fee").val(r.toFixed(2))},onSignUpSubmit:function(e){return this._collectFormData(),this.sign_form_model.isValid()&&this.sign_form_model.save(),!1},onSignModelInValid:function(e,t){this.trigger("invalid:sign",this,t)},onSignModelOrderInfoChange:function(e,t){this.trigger("ordergen",this,this._getOrderInfo())},_collectFormData:function(){this.sign_form_model.clear({silent:!0});var t=this;e("[name]:visible").each(function(n,r){if(e(r).is("radio")&&e(r).prop("checked")==0)return;var i=e(r).attr("name"),s=e(r).val();t.sign_form_model.set(i,s,{silent:!0})});if(this.model.get("need_pay")==1){var n=[];e("#activity_pay_items_container .activity-pay-item").each(function(t,r){var i=e(r).find(".activity-pay-item-number").numberspinner("getValue");if(i==0)return;var s={};s.id=e(r).attr("data-id"),s.number=i,n.push(s)}),t.sign_form_model.set("pay_items",n)}t.sign_form_model.set("aid",this.model.get("id")),t.sign_form_model.set("user_id",G.user.user_id)},_getOrderInfo:function(){var e=this.sign_form_model.get("order_info"),t=this.model.get("pay_types");if(e&&e instanceof Object){e.pay_type={offline:0,alipay:0,wxpay:0};if(t.indexOf("CASH")!=-1||t.indexOf("POS")!=-1||t.indexOf("TRANSFER")!=-1)e.pay_type.offline=1;t.indexOf("ONLINE")!=-1&&(e.pay_type.alipay=1,e.pay_type.wxpay=1)}var n=this.model.get("name");return e.order_des=n=="t1"?"活动名称":"for auto life",e}});return a});