define(["jquery","underscore","backbone","models/driving_tour/TourModel","models/driving_tour/TourSignFormModel","text!templates/driving_tour/tour_detail_page.html","text!templates/driving_tour/tour_detail.html","pcas","jqm"],function(e,t,n,r,i,s,o,u){e(s).appendTo("body");var a=n.View.extend({detail_tpl:t.template(o),model:new r,sign_form_model:new i,el:"#tour_detail_page",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.sign_form_model,"invalid",this.onSignModelInValid),this.listenTo(this.sign_form_model,"change:order_info",this.onSignModelOrderInfoChange),new u("tour_province","tour_city","tour_area")},render:function(t,n){this.$el.find(".detail-container").empty(),this.$el.find("#tour_sign_up_btn").hide();if(t.keys().length==0)return;this.$el.find(".detail-container").append(this.detail_tpl(t.toJSON()));var r=t.get("state"),i=t.get("sign_start_date"),s=t.get("sign_end_date"),o=new Date(i),u=new Date(s),a=Date.today();r!=1||i&&Date.compare(o,a)==1||s&&Date.compare(u,a)==-1?this.$el.find("#tour_sign_up_btn").hide():this.$el.find("#tour_sign_up_btn").show();var f=t.get("infos")||"";this.$el.find("#tour_sign_up_form_container [data-field]").each(function(t,n){var r=e(n).attr("data-field");f.indexOf(r)!=-1?e(n).show():e(n).hide()}),e('[data-field="auto"]').find("#tour_option_label").text(t.get("option")),e('[name="user_id"]').val(G.user.user_id);var l=t.get("need_pay");if(l==1){e('#tour_sign_up_form_container [data-field="pay_items"]').show(),e('#tour_sign_up_form_container [data-field="total_fee"]').show(),e('#tour_sign_up_form_container [name="total_fee"]').text("0.00");var c=t.get("goods"),h=c.length;e("#tour_pay_items_container").empty();for(var p=0;p<h;p++){var d=e('<tr class="tour-pay-item" data-id="'+c[p].id+'" data-price="'+c[p].price+'"></tr>');e("#tour_pay_items_container").append(d),d.append("<td>"+c[p].name+"</td>"),d.append('<td class="cm-color-money">'+c[p].price+"</td>"),d.append('<td class="cm-numberspinner cm-span6 tour-pay-item-number"></td>'),d.find(".cm-numberspinner").numberspinner({change:function(t,n){var r=0;e("#tour_pay_items_container .tour-pay-item").each(function(t,n){var i=Number(e(n).attr("data-price")),s=e(n).find(".tour-pay-item-number").numberspinner("getValue");r+=i*s}),e('#tour_sign_up_form_container [name="total_fee"]').text(Number(r).toFixed(2))}})}}else e('#tour_sign_up_form_container [data-field="pay_items"]').hide()},events:{"click #tour_sign_up_btn":"onSignUpBtnClick","click #tour_sign_up_submit_btn":"onSignUpSubmit",'change [name="pay_type"]':"onPayTypeChange"},onSignUpBtnClick:function(t){return t.preventDefault(),e("#tour_sign_up_popup").popup("open"),!1},onPeopleNumberInput:function(e){var t=this.$el.find('[name="people"]').val(),n=this.$el.find('[name="deposit"]').val(),r=Number(t)*Number(n);this.$el.find("total_fee").val(r.toFixed(2))},onSignUpSubmit:function(e){return this._collectFormData(),this.sign_form_model.isValid()&&this.sign_form_model.save(),!1},onSignModelInValid:function(e,t){this.trigger("invalid:sign",this,t)},onSignModelOrderInfoChange:function(e,t){this.trigger("ordergen",this,this._getOrderInfo())},_collectFormData:function(){this.sign_form_model.clear({silent:!0});var t=this;e("[name]:visible").each(function(n,r){var i=e(r).attr("name"),s=e(r).val();t.sign_form_model.set(i,s,{silent:!0})});var n=[];e("#tour_pay_items_container .tour-pay-item").each(function(t,r){var i=e(r).find(".tour-pay-item-number").numberspinner("getValue");if(i==0)return;var s={};s.id=e(r).attr("data-id"),s.number=i,n.push(s)}),t.sign_form_model.set("pay_items",n),t.sign_form_model.set("aid",this.model.get("id")),t.sign_form_model.set("user_id",G.user.user_id)},_getOrderInfo:function(){var e=this.sign_form_model.get("order_info"),t=this.model.get("pay_types");if(e&&e instanceof Object){e.pay_type={offline:0,alipay:0,wxpay:0};if(t.indexOf("CASH")!=-1||t.indexOf("POS")!=-1||t.indexOf("TRANSFER")!=-1)e.pay_type.offline=1;t.indexOf("ONLINE")!=-1&&(e.pay_type.alipay=1,e.pay_type.wxpay=1)}return e}});return a});